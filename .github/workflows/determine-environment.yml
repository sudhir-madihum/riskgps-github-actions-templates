name: Determine Environment (Reusable)

# This is a REUSABLE WORKFLOW to determine environment and ECR push decision
# Call from your service repo with:
#   uses: org/riskgps-github-actions-templates/.github/workflows/determine-environment.yml@main
#   with:
#     dev-branch: dev
#     prod-branch: prod

on:
  workflow_call:
    inputs:
      dev-branch:
        required: false
        type: string
        default: "dev"
        description: "Development branch name"
      prod-branch:
        required: false
        type: string
        default: "prod"
        description: "Production branch name"
      skip-tests-on-prod:
        required: false
        type: boolean
        default: true
        description: "Skip tests when merging to prod"
    outputs:
      environment:
        description: "Determined environment (feature/dev/prod)"
        value: ${{ jobs.determine.outputs.environment }}
      should-push-ecr:
        description: "Whether to push to ECR (true for merges, false for PRs/features)"
        value: ${{ jobs.determine.outputs.should-push-ecr }}
      run-tests:
        description: "Whether to run tests"
        value: ${{ jobs.determine.outputs.run-tests }}
      should-build:
        description: "Whether to build Docker image"
        value: ${{ jobs.determine.outputs.should-build }}

jobs:
  determine:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should-push-ecr: ${{ steps.set-env.outputs.should-push-ecr }}
      run-tests: ${{ steps.set-env.outputs.run-tests }}
      should-build: ${{ steps.set-env.outputs.should-build }}
    steps:
      - name: Determine environment and ECR push decision
        id: set-env
        shell: bash
        run: |
          BRANCH="${{ github.ref_name }}"
          EVENT="${{ github.event_name }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          SHOULD_BUILD="true"
          SHOULD_PUSH_ECR="false"
          RUN_TESTS="true"
          ENVIRONMENT="feature"
          
          DEV_BRANCH="${{ inputs.dev-branch }}"
          PROD_BRANCH="${{ inputs.prod-branch }}"
          SKIP_TESTS_PROD="${{ inputs.skip-tests-on-prod }}"
          
          echo "ðŸ“ Event: $EVENT"
          echo "ðŸ“ Source Branch: $BRANCH"
          echo "ðŸ“ Target Branch: $TARGET_BRANCH"
          echo "ðŸ“ Dev Branch: $DEV_BRANCH"
          echo "ðŸ“ Prod Branch: $PROD_BRANCH"
          echo ""
          
          if [[ "$EVENT" == "push" ]]; then
            # PUSH EVENT: Determine if merging to dev/prod
            if [[ "$BRANCH" == "$DEV_BRANCH" ]]; then
              ENVIRONMENT="dev"
              SHOULD_PUSH_ECR="true"
              RUN_TESTS="true"
              echo "âœ… Merge to $DEV_BRANCH branch detected"
              echo "âœ… Will run tests, scan, build, and PUSH to $DEV_BRANCH ECR"
            elif [[ "$BRANCH" == "$PROD_BRANCH" ]]; then
              ENVIRONMENT="prod"
              SHOULD_PUSH_ECR="true"
              if [[ "$SKIP_TESTS_PROD" == "true" ]]; then
                RUN_TESTS="false"
              else
                RUN_TESTS="true"
              fi
              echo "âœ… Merge to $PROD_BRANCH branch detected"
              echo "âœ… Will scan, build, and PUSH to $PROD_BRANCH ECR (tests: $RUN_TESTS)"
            else
              ENVIRONMENT="feature"
              SHOULD_PUSH_ECR="false"
              RUN_TESTS="true"
              echo "âœ… Push to feature branch '$BRANCH' detected"
              echo "âœ… Will run tests, scan, and build (will NOT push to ECR)"
            fi
          elif [[ "$EVENT" == "pull_request" ]]; then
            # PR EVENT: Determine target branch
            if [[ "$TARGET_BRANCH" == "$DEV_BRANCH" ]]; then
              ENVIRONMENT="dev"
              SHOULD_PUSH_ECR="false"
              RUN_TESTS="true"
              echo "âœ… Pull request to $DEV_BRANCH detected"
              echo "âœ… Will run tests, scan, and build (will NOT push to ECR)"
            elif [[ "$TARGET_BRANCH" == "$PROD_BRANCH" ]]; then
              ENVIRONMENT="prod"
              SHOULD_PUSH_ECR="false"
              if [[ "$SKIP_TESTS_PROD" == "true" ]]; then
                RUN_TESTS="false"
              else
                RUN_TESTS="true"
              fi
              echo "âœ… Pull request to $PROD_BRANCH detected"
              echo "âœ… Will scan and build (will NOT push to ECR, tests: $RUN_TESTS)"
            else
              ENVIRONMENT="feature"
              SHOULD_PUSH_ECR="false"
              RUN_TESTS="true"
              echo "âœ… Pull request to feature branch detected"
              echo "âœ… Will run tests, scan, and build (will NOT push to ECR)"
            fi
          fi
          
          echo ""
          echo "ðŸ”§ Final Configuration:"
          echo "   Environment: $ENVIRONMENT"
          echo "   Run Tests: $RUN_TESTS"
          echo "   Build Docker Image: $SHOULD_BUILD"
          echo "   Push to ECR: $SHOULD_PUSH_ECR"
          echo "   Event Type: $EVENT"
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "should-push-ecr=$SHOULD_PUSH_ECR" >> $GITHUB_OUTPUT
          echo "run-tests=$RUN_TESTS" >> $GITHUB_OUTPUT
          echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
