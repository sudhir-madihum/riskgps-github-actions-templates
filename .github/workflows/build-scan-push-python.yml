name: Build, Scan, and Push - Python Service (Reusable)

# This is a REUSABLE WORKFLOW template for Python services
# Call from your service repo with:
#   uses: org/riskgps-github-actions-templates/.github/workflows/build-scan-push-python.yml@main
#   with:
#     service-name: backend-agent
#     dockerfile-path: ./Dockerfile

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "Service name (e.g., backend-agent, backend-connector)"
      dockerfile-path:
        required: false
        type: string
        default: "./Dockerfile"
        description: "Path to Dockerfile"
      docker-build-context:
        required: false
        type: string
        default: "."
        description: "Docker build context path"
      python-version:
        required: false
        type: string
        default: "3.11"
        description: "Python version"
      run-tests:
        required: false
        type: boolean
        default: true
        description: "Whether to run pytest"
      run-linter:
        required: false
        type: boolean
        default: true
        description: "Whether to run flake8"
      push-to-ecr:
        required: false
        type: boolean
        default: false
        description: "Whether to push image to ECR"
      ecr-registry-url:
        required: false
        type: string
        description: "ECR registry URL (e.g., 739962689681.dkr.ecr.us-east-1.amazonaws.com)"
      ecr-repository-name:
        required: false
        type: string
        description: "ECR repository name (e.g., bluocean-riskgps-dev-backend-agent)"
    outputs:
      image-name:
        description: "Built Docker image name (e.g., backend-agent:v1.0.10)"
        value: ${{ jobs.build-docker-image.outputs.image-name }}
      image-tag:
        description: "Built Docker image tag (e.g., v1.0.10)"
        value: ${{ jobs.build-docker-image.outputs.image-tag }}
      ecr-image-pushed:
        description: "Full ECR image URL if pushed (e.g., 739962689681.dkr.ecr.us-east-1.amazonaws.com/bluocean-riskgps-dev-backend-agent:v1.0.10)"
        value: ${{ jobs.build-docker-image.outputs.ecr-image-pushed }}
permissions:
  id-token: write
  contents: read

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          echo "âœ… Reusable workflow inputs validated"
          echo "   Service: ${{ inputs.service-name }}"
          echo "   Dockerfile: ${{ inputs.dockerfile-path }}"
          echo "   Context: ${{ inputs.docker-build-context }}"
          echo "   Python Version: ${{ inputs.python-version }}"
          echo "   Run Tests: ${{ inputs.run-tests }}"
          echo "   Run Linter: ${{ inputs.run-linter }}"

  run-tests:
    name: Run Tests & Linting
    runs-on: ubuntu-latest
    if: ${{ inputs.run-tests == true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for ${{ inputs.service-name }}"
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov flake8

      - name: Run linter
        if: ${{ inputs.run-linter == true }}
        run: |
          echo "ðŸ” Running flake8 linter"
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "âš ï¸ Linter warnings found but continuing"
          echo "âœ… Linting completed"

      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running pytest for ${{ inputs.service-name }}"
          pytest --cov=. --cov-report=xml --cov-report=term || echo "âš ï¸ Tests had issues but continuing"
          echo "âœ… Tests completed"

  scan-files:
    name: Scan Source Files with Trivy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

  build-docker-image:
    name: Build and Scan Docker Image
    runs-on: ubuntu-latest
    needs: [run-tests, scan-files]
    if: |
      always() &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped') &&
      (needs.scan-files.result == 'success' || needs.scan-files.result == 'skipped')
    outputs:
      image-tag: ${{ steps.generate-tag.outputs.tag }}
      image-name: ${{ steps.generate-tag.outputs.image-name }}
      ecr-image-pushed: ${{ steps.push-to-ecr.outputs.ecr-image || '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Image Tag
        id: generate-tag
        shell: bash
        run: |
          SERVICE="${{ inputs.service-name }}"
          MAJOR_VERSION="1"
          MINOR_VERSION="0"
          TAG="v${MAJOR_VERSION}.${MINOR_VERSION}.${{ github.run_number }}"
          IMAGE_NAME="${SERVICE}:${TAG}"
          
          echo "ðŸ“Š Image Information:"
          echo "   Service: $SERVICE"
          echo "   Tag: $TAG"
          echo "   Image Name: $IMAGE_NAME"
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "image-name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          echo "ðŸ”¨ Building Docker image: ${{ steps.generate-tag.outputs.image-name }}"
          docker build \
            -t ${{ steps.generate-tag.outputs.image-name }} \
            -f ${{ inputs.dockerfile-path }} \
            ${{ inputs.docker-build-context }}
          echo "âœ… Docker image built successfully"

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: ${{ steps.generate-tag.outputs.image-name }}
          format: "table"
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      - name: Login to ECR (if pushing)
        if: ${{ inputs.push-to-ecr == true }}
        uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr

      - name: Push to ECR
        if: ${{ inputs.push-to-ecr == true }}
        id: push-to-ecr
        run: |
          ECR_REGISTRY="${{ inputs.ecr-registry-url }}"
          ECR_REPOSITORY="${{ inputs.ecr-repository-name }}"
          IMAGE_TAG="${{ steps.generate-tag.outputs.tag }}"
          LOCAL_IMAGE="${{ steps.generate-tag.outputs.image-name }}"
          ECR_IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          
          echo "ðŸ“¤ Pushing to ECR..."
          echo "   Registry: $ECR_REGISTRY"
          echo "   Repository: $ECR_REPOSITORY"
          echo "   Tag: $IMAGE_TAG"
          echo "   Full Image: $ECR_IMAGE"
          
          docker tag $LOCAL_IMAGE $ECR_IMAGE
          docker push $ECR_IMAGE
          
          echo "âœ… Pushed: $ECR_IMAGE"
          echo "ecr-image=$ECR_IMAGE" >> $GITHUB_OUTPUT

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-inputs, run-tests, scan-files, build-docker-image]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## âœ… Python Pipeline Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Inputs Validated | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests & Linting | ${{ needs.run-tests.result == 'success' && 'âœ…' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Scan | ${{ needs.scan-files.result == 'success' && 'âœ…' || 'âš ï¸ Warning' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build-docker-image.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image built: \`${{ needs.build-docker-image.outputs.image-name }}\`" >> $GITHUB_STEP_SUMMARY
